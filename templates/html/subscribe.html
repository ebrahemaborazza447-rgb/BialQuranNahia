{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>بالقرآن نحيا - اشتراك مرحلة {{ plan.name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Tajawal:700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #a99d94;
      font-family: 'Tajawal', Arial, sans-serif;
    }
    .navbar-custom {
      background-color: #1a3a30 !important;
      border-bottom: 2px solid #c9b67a;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
    }
    .navbar-brand {
      font-weight: bold;
      color: #fff !important;
      font-family: 'Tajawal', Arial, sans-serif;
      font-size: 1.5rem;
      letter-spacing: 1px;
    }
    .navbar-logo {
      height: 38px;
      margin-left: 10px;
    }
    .welcome {
      text-align: center;
      margin-top: 90px;
      margin-bottom: 35px;
      font-size: 22px;
      font-weight: bold;
    }
    .form-section,
    .side-section {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      margin-bottom: 24px;
      padding: 32px 24px;
    }
    .submit-btn {
      background: #1a3a30;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 90px;
      font-size: 18px;
      font-weight: bold;
      margin: 30px auto 0;
      display: block;
      transition: all 0.3s;
      width: 100%;
    }
    .submit-btn:hover {
      background: #c9b67a;
      color: #1a3a30;
    }
    .form-control {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }
    .form-label {
      font-weight: bold;
      margin-bottom: 8px;
      display: block;
    }
    .alert {
      border-radius: 8px;
      margin-bottom: 20px;
      padding: 12px;
      text-align: center;
    }
    .warning-box-inline {
      display: inline-block;
      margin-right: 10px;
      margin-left: 10px;
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 0.95em;
      vertical-align: middle;
      min-width: 120px;
    }
    .readonly-bg {
      background: #f2f2f2 !important;
      color: #333 !important;
    }
    .appointment-btn {
      min-width: 160px;
      margin-bottom: 6px;
    }
    .appointment-btn.booked,
    .appointment-btn:disabled {
      background: #e0e0e0 !important;
      color: #888 !important;
      border: 1px solid #ccc !important;
      cursor: not-allowed !important;
      position: relative;
    }
    .appointment-btn.booked::after {
      content: "محجوز";
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #b71c1c;
      font-size: 0.9em;
      font-weight: bold;
    }
  </style>
</head>

<body class="bg-gray-50">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <img src="{% static 'images/logo.png' %}" alt="شعار المنصة" class="navbar-logo">
        <span>بالقرآن نحيا</span>
      </a>
    </div>
  </nav>

  <div class="welcome">مرحبا بك في اشتراك مرحلة <span style="color:#1a3a30;">{{ plan.name }}</span></div>
  <div class="container">
    <div class="row justify-content-center g-4">
      <!-- بيانات المرحلة -->
      <div class="col-lg-5 col-md-8 order-1 order-lg-2">
        <div class="side-section">
          <div class="mb-3 fw-bold d-flex align-items-center">
            <span class="mb-0">بيانات المرحلة</span>
          </div>
          <ul class="list-group mb-4">
            <li class="list-group-item readonly-bg"><b>اسم المرحلة:</b> {{ plan.name }}</li>
            <li class="list-group-item readonly-bg"><b>الوصف:</b> {{ plan.description }}</li>
            <li class="list-group-item readonly-bg"><b>السعر:</b> {{ plan.price }} جنيه</li>
            <li class="list-group-item readonly-bg"><b>مدة الاشتراك:</b> {{ plan.duration_text }}</li>
            <li class="list-group-item readonly-bg"><b>اسم المعلم:</b> {{ plan.teacher }}</li>
          </ul>
          <div class="mb-3 fw-bold">طريقة الدفع بي فودافون كاش مع ارفاق ورفع صورة من الدفع في الأسفل</div>
          <div class="mb-4">
            <button type="button" class="btn btn-secondary">Vodafone Cash 01000251322</button>
          </div>
        </div>
      </div>

      <!-- نموذج التسجيل -->
      <div class="col-lg-6 col-md-8 order-2 order-lg-1">
        <div class="form-section">
          <form method="post" enctype="multipart/form-data" class="form">
  {% csrf_token %}
  {{ form.non_field_errors }}

  <input type="hidden" id="appointment_id" name="appointment_id" value="">

  <div class="mb-4">
    <label class="form-label">المواعيد المتاحة</label>
    <div id="appointments-container" class="mb-4"></div>
    <span id="appointment-warning" class="text-danger" style="display:none;"></span>
  </div>

  <div class="mb-4">
    <label class="form-label">رفع صورة إيصال الدفع</label>
    {{ form.payment_image }}
    <span id="payment-warning" class="text-danger" style="display:none;"></span>
  </div>

  <button type="submit" class="submit-btn btn btn-success w-100" id="confirmPaymentBtn" disabled>
    تأكيد العملية
  </button>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const appointmentInput = document.getElementById("appointment_id");
  const paymentInput     = document.getElementById("id_payment_image"); // ID الافتراضي لحقل الصورة من Django
  const confirmBtn       = document.getElementById("confirmPaymentBtn");
  const appointmentWarn  = document.getElementById("appointment-warning");
  const paymentWarn      = document.getElementById("payment-warning");

  function checkFormReady(showWarnings=false){
    let ok = true;

    if(!appointmentInput.value){
      ok = false;
      if(showWarnings){ appointmentWarn.textContent = "يجب اختيار موعد"; appointmentWarn.style.display = "inline-block"; }
    } else { appointmentWarn.style.display = "none"; }

    if(!(paymentInput.files && paymentInput.files.length > 0)){
      ok = false;
      if(showWarnings){ paymentWarn.textContent = "يجب رفع صورة إيصال الدفع"; paymentWarn.style.display = "inline-block"; }
    } else { paymentWarn.style.display = "none"; }

    confirmBtn.disabled = !ok;
    return ok;
  }
// تحميل المواعيد بناءً على plan.id + phase
function loadAppointments(){
  const container = document.getElementById("appointments-container");
  container.innerHTML = "جاري تحميل المواعيد...";

  fetch(`/get_appointments/?plan_id={{ plan.id }}&phase={{ plan.name }}`)
    .then(r => r.json())
    .then(list => {
      container.innerHTML = "";
      if(list.length === 0){
        container.innerHTML = "<p>لا توجد مواعيد متاحة لهذه المرحلة حالياً.</p>";
        checkFormReady();
        return;
      }
      list.forEach(app => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-outline-primary appointment-btn m-1";
        btn.textContent = `${app.day} - ${app.time} ${app.period}`;
        if(app.is_booked){
          btn.disabled = true;
          btn.classList.add("booked");
        }else{
          btn.addEventListener("click", () => {
            appointmentInput.value = app.id;
            container.querySelectorAll("button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            checkFormReady();
          });
        }
        container.appendChild(btn);
      });
    })
    .catch(() => {
      container.innerHTML = "<span class='text-danger'>حدث خطأ أثناء تحميل المواعيد</span>";
    });
}

paymentInput.addEventListener("change", () => checkFormReady());
document.querySelector("form.form").addEventListener("submit", function(e){
  if(!checkFormReady(true)){ e.preventDefault(); }
});

loadAppointments();

});
</script>
        </div>
      </div>
    </div>
  </div>
</div>
