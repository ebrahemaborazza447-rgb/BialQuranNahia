{% load static %}
<!DOCTYPE html>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<html lang="ar" dir="rtl">
<style>
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    /* لما يتفعل */
    input:checked+.slider {
        background-color: #2196F3;
        /* أزرق جميل */
    }

    input:checked+.slider:before {
        transform: translateX(26px);
    }


    .popup-notif {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #2c3e50;
        color: #fff;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    [x-cloak] {
        display: none !important;
    }
</style>


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحة الطالب - منصة القرآن الكريم</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.0.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>

    <!-- ECharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/student_dashboard.css' %}">
</head>

<body class="bg-gray-50">
    <header class="fixed w-full top-0 z-50" style="background-color: #1a3a30; border-bottom: 2px solid #c9b67a;">
        <div class="container mx-auto px-3">
            <nav class="flex items-center justify-between py-1">
                <!-- Logo -->
                <a href="{% url 'inbox' %}" class="flex items-center space-x-2 no-underline">
                    <img src="{% static 'images/logo.png' %}" alt="شعار المنصة" class="h-10 ml-3">
                    <span class="font-bold text-white text-lg font-['Tajawal']">بالقرآن نحيا</span>
                </a>


                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-3 space-x-reverse">
                    <!-- Update these links in your navigation -->
                    <a href="{% url 'inbox' %}"
                        class="text-white hover:text-gray-200 text-sm font-medium px-2 py-1">الرئيسية</a>
                    <a href="{% url 'about_me' %}"
                        class="text-white hover:text-gray-200 text-sm font-medium px-2 py-1">المعلمون</a>
                    <a href="{% url 'contact' %}"
                        class="text-white hover:text-gray-200 text-sm font-medium px-2 py-1">تواصل معنا</a>
                    <a href="{% url 'message_list' %}" class="relative ml-4">
                        <i class="ri-notification-3-line text-white"></i>
                        {% if unread_messages_count > 0 %}
                        <span
                            class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] rounded-full h-4 w-4 flex items-center justify-center">
                            {{ unread_messages_count }}
                        </span>
                        {% endif %}


                    </a>




                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full overflow-hidden ml-2">
                            <img id="navbar-image"
                                src="{% if student_data.image %}{{ student_data.image.url }}{% else %}https://via.placeholder.com/100{% endif %}"
                                alt="صورة المستخدم" class="w-full h-full object-cover">
                        </div>
                        <span class="text-white text-sm font-medium mr-1">
                            {{ student_data.name|default:'مرحباً' }}
                        </span>
                    </div>
                </div>
        </div>

        <!-- Mobile menu button -->
        <div class="md:hidden">
            <button id="menu-toggle" class="md:hidden text-white p-2 focus:outline-none">
                <!-- أيقونة 3 شرط -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>
        </nav>
        </div>

        <!-- Mobile menu -->
        <div class="md:hidden hidden bg-green-800" id="mobile-menu">
            <div class="px-2 py-1 space-y-0">
                <a href="#" class="block px-3 py-1.5 text-sm text-white hover:bg-green-700">الرئيسية</a>
                <a href="#" class="block px-3 py-1.5 text-sm text-white hover:bg-green-700">المعلمون</a>
                <a href="#" class="block px-3 py-1.5 text-sm text-white hover:bg-green-700">تواصل معنا</a>
                <div class="pt-2 border-t border-green-700">
                    <div class="flex items-center px-3 py-1.5">
                        <div class="w-7 h-7 rounded-full overflow-hidden ml-2">
                            <img src="{% if student_data.image %}{{ student_data.image.url }}{% else %}https://via.placeholder.com/100{% endif %}"
                                alt="صورة المستخدم" class="w-full h-full object-cover">
                        </div>
                        <span class="text-white text-sm">
                            {{ student_data.name|default:'حسابي' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <!-- Add padding to the top of the main content to account for fixed header -->
    <main class="pt-16">
        <!-- Your page content here -->
    </main>

    <script>
        // Mobile menu toggle
        document.getElementById('menu-toggle').addEventListener('click', function () {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });
    </script>
    <!-- Main Content -->
<main class="container mx-auto px-4 mt-20 pb-12">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Sidebar -->
        <aside class="lg:col-span-1 space-y-6">
            <div class="card card-hover text-center p-6" id="student-card">
                <div class="bg-white p-6 rounded-lg shadow text-center">
                    <img id="main-image"
                        src="{% if student_data.image %}{{ student_data.image.url }}{% else %}https://via.placeholder.com/100{% endif %}"
                        alt="صورة الطالب" class="w-24 h-24 rounded-full object-cover mx-auto">

                    <h2 id="main-name" class="text-xl font-bold text-center mb-1">
                        {{ student_data.name|default:"-" }}
                    </h2>

                    {% if student_data.age %}
                        <span class="text-gray-600">العمر:</span>
                        <span id="main-age" class="text-gray-600 text-center mb-1">
                            {{ student_data.age }}
                        </span>
                    {% endif %}

                    {% if student_data.city %}
                        <span class="text-gray-600">المدينة:</span>
                        <span id="main-city" class="text-gray-600 text-center mb-4">
                            {{ student_data.city }}
                        </span>
                    {% endif %}

                    <div id="main-extra">
                        {% if student_data.level or student_data.current_surah or student_data.current_juz %}
                        <div class="w-full border-t border-gray-200 my-4"></div>
                        <div class="w-full space-y-2">
                            {% if student_data.level %}
                            <div class="flex justify-between">
                                <span class="text-gray-600">المستوى الحالي:</span>
                                <span class="font-medium text-primary text-right" id="main-level">
                                    {{ student_data.level }}
                                </span>
                            </div>
                            {% endif %}
                            {% if student_data.current_surah %}
                            <div class="flex justify-between">
                                <span class="text-gray-600">السورة الحالية:</span>
                                <span class="font-medium text-primary text-right" id="main-surah">
                                    {{ student_data.current_surah }}
                                </span>
                            </div>
                            {% endif %}
                            {% if student_data.current_juz %}
                            <div class="flex justify-between">
                                <span class="text-gray-600">الجزء الحالي:</span>
                                <span class="font-medium text-primary text-right" id="main-juz">
                                    {{ student_data.current_juz }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- زر تعديل البيانات ونافذة التعديل -->
                    <div x-data="{ open: false }">
                        <!-- الزر -->
                        <a href="#" @click.prevent="open = true"
                            class="mt-4 inline-block bg-primary text-white px-4 py-2 rounded shadow hover:bg-primary/80">
                            تعديل البيانات
                        </a>

                        <!-- الفورمة (Modal) -->
                        <div x-show="open" x-cloak
                            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                            x-transition>
                            <div class="bg-white p-6 rounded-lg shadow-lg w-96 relative">
                                <h3 class="text-lg font-bold mb-4">إدخال بيانات المستخدم</h3>
                                <form id="profile-form" method="POST" action="{% url 'update_profile_data' %}"
                                    enctype="multipart/form-data">
                                    {% csrf_token %}
                                    
                                    <label class="block mb-2">الصورة:</label>
                                    <div class="flex items-center gap-4 mb-3">
                                        <img id="image-preview"
                                            src="{% if student_data.image %}{{ student_data.image.url }}{% else %}https://via.placeholder.com/100{% endif %}"
                                            alt="صورة الطالب" class="w-20 h-20 object-cover rounded-full border">
                                        <input type="file" name="image" accept="image/*"
                                            class="border rounded p-2 w-full" onchange="previewImage(event)">
                                    </div>

                                    <label class="block mb-2">الاسم:</label>
                                    <input type="text" name="name" id="input-name"
                                        value="{{ student_data.name|default_if_none:'' }}"
                                        class="w-full border rounded p-2 mb-3">

                                    <label class="block mb-2">العمر:</label>
                                    <input type="number" name="age" id="input-age"
                                        value="{{ student_data.age|default_if_none:'' }}" min="1"
                                        class="w-full border rounded p-2 mb-3">

                                    <label class="block mb-2">المدينة:</label>
                                    <input type="text" name="city" id="input-city"
                                        value="{{ student_data.city|default_if_none:'' }}"
                                        class="w-full border rounded p-2 mb-3">

                                    <label class="block mb-2">المستوى الحالي:</label>
                                    <input type="text" name="level" id="input-level"
                                        value="{{ student_data.level|default_if_none:'' }}"
                                        class="w-full border rounded p-2 mb-3">

                                    <label class="block mb-2">السورة الحالية:</label>
                                    <input type="text" name="current_surah" id="input-surah"
                                        value="{{ student_data.current_surah|default_if_none:'' }}"
                                        class="w-full border rounded p-2 mb-3">

                                    <label class="block mb-2">الجزء الحالي:</label>
                                    <input type="number" name="current_juz" id="input-juz"
                                        value="{{ student_data.current_juz|default_if_none:'' }}" min="1" max="30"
                                        class="w-full border rounded p-2 mb-3">

                                    <div class="flex justify-end gap-2 mt-4">
                                        <button type="button" @click="open = false"
                                            class="px-4 py-2 border rounded-lg">
                                            إلغاء
                                        </button>
                                        <button type="submit" @click="open = false" id="save-btn"
                                            class="px-4 py-2 bg-primary text-white rounded-lg shadow flex items-center gap-2 hover:bg-primary/80 transition">
                                            <span id="save-btn-text">💾 حفظ</span>
                                            <span id="save-btn-loader"
                                                class="hidden animate-spin border-2 border-white border-t-transparent rounded-full w-4 h-4"></span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            
                    <div id="alert-box"
                        class="fixed top-5 right-5 z-50 hidden bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg">
                    </div>

                    <!-- اسكربت معاينة الصورة -->
                    <script>
                        function previewImage(event) {
                            var reader = new FileReader();
                            reader.onload = function () {
                                var output = document.getElementById('image-preview');
                                output.src = reader.result;
                            };
                            if (event.target.files && event.target.files[0]) {
                                reader.readAsDataURL(event.target.files[0]);
                            }
                        }
                    </script>

                    <!-- AJAX تحديث البيانات والصورة -->
                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            const form = document.getElementById('profile-form');
                            if (form) {
                                form.addEventListener('submit', function (e) {
                                    e.preventDefault();
                                    let formData = new FormData(form);

                                    fetch(form.action, {
                                        method: 'POST',
                                        headers: {
                                            'X-Requested-With': 'XMLHttpRequest'
                                        },
                                        body: formData
                                    })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                // تحديث البيانات والصورة
                                                if (data.image_url) {
                                                    document.getElementById('main-image').src = data.image_url;
                                                    document.getElementById('image-preview').src = data.image_url;
                                                }
                                                document.getElementById('main-name').textContent = data.name || '-';
                                                document.getElementById('main-age').textContent = data.age || '';
                                                document.getElementById('main-city').textContent = data.city || '';

                                                // تحديث الحقول الإضافية
                                                let extraHtml = '';
                                                if (data.level || data.current_surah || data.current_juz) {
                                                    extraHtml += '<div class="w-full border-t border-gray-200 my-4"></div><div class="w-full space-y-2">';
                                                    if (data.level)
                                                        extraHtml += `<div class="flex justify-between"><span class="text-gray-600">المستوى الحالي:</span><span class="font-medium text-primary text-right">${data.level}</span></div>`;
                                                    if (data.current_surah)
                                                        extraHtml += `<div class="flex justify-between"><span class="text-gray-600">السورة الحالية:</span><span class="font-medium text-primary text-right">${data.current_surah}</span></div>`;
                                                    if (data.current_juz)
                                                        extraHtml += `<div class="flex justify-between"><span class="text-gray-600">الجزء الحالي:</span><span class="font-medium text-primary text-right">${data.current_juz}</span></div>`;
                                                    extraHtml += '</div>';
                                                }
                                                document.getElementById('main-extra').innerHTML = extraHtml;

                                                // 🔥 إظهار رسالة نجاح
                                                let alertBox = document.getElementById("alert-box");
                                                alertBox.textContent = data.message || "تم الحفظ بنجاح ✅";
                                                alertBox.classList.remove("hidden");
                                                setTimeout(() => {
                                                    alertBox.classList.add("hidden");
                                                }, 3000);
                                            } else if (data.errors) {
                                                let alertBox = document.getElementById("alert-box");
                                                alertBox.textContent = "حدث خطأ في البيانات: " + JSON.stringify(data.errors);
                                                alertBox.classList.remove("hidden");
                                                setTimeout(() => {
                                                    alertBox.classList.add("hidden");
                                                }, 3000);
                                            } else {
                                                let alertBox = document.getElementById("alert-box");
                                                alertBox.textContent = "حدث خطأ غير متوقع!";
                                                alertBox.classList.remove("hidden");
                                                setTimeout(() => {
                                                    alertBox.classList.add("hidden");
                                                }, 3000);
                                            }
                                        })

                                });
                            }
                        });

                    </script>

                    <!-- Alpine.js و x-cloak CSS -->
                    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
                    <style>
                        [x-cloak] {
                            display: none !important;
                        }
                    </style>


                    </div>
            </aside>

            <!-- Main Content Area -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Progress Section -->
                <div class="card card-hover">
                    <h2 class="text-xl font-bold mb-6">تقدمك في الحفظ</h2>
                    <div class="flex flex-col md:flex-row">
                        <!-- Progress Ring -->
                        <!-- Progress Ring -->
                        <div class="flex-1 flex justify-center mb-6 md:mb-0">
                            <div class="relative w-48 h-48">
                                <svg width="160" height="160" class="progress-ring">
                                    <!-- دائرة الخلفية -->
                                    <circle stroke="#e6e6e6" stroke-width="10" fill="transparent" r="70" cx="80"
                                        cy="80" />
                                    <!-- دائرة التقدم -->
                                    <circle id="progressCircle" stroke="#2E7D32" stroke-width="10" fill="transparent"
                                        r="70" cx="80" cy="80"
                                        style="transform: rotate(-90deg); transform-origin: 50% 50%;" />
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span id="progressPercent" class="text-3xl font-bold text-primary">
                                        {{ student_data.progress|default:0 }}%
                                    </span>
                                    <span class="text-sm text-gray-600">من الهدف</span>
                                </div>
                            </div>
                        </div>

                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                // جلب قيمة التقدم من الدجانغو
                                var progress = parseFloat("{{ student_data.progress|default:0 }}");
                                progress = Math.max(0, Math.min(100, progress)); // تأكد أنها بين 0 و 100

                                var circle = document.getElementById('progressCircle');
                                var radius = 70;
                                var circumference = 2 * Math.PI * radius;

                                circle.setAttribute('stroke-dasharray', circumference);
                                // حساب الجزء غير المكتمل
                                var offset = circumference - (progress / 100) * circumference;
                                circle.setAttribute('stroke-dashoffset', offset);

                                // تحديث الرقم في المنتصف
                                var percentText = document.getElementById('progressPercent');
                                if (percentText) {
                                    percentText.textContent = progress + "%";
                                }
                            });
                        </script>
                        <!-- Stats Cards -->
                        <div class="flex-1">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Saved Parts -->
                                <div class="bg-green-50 rounded-lg p-4 card-hover">
                                    <div class="flex items-center mb-2">
                                        <i class="ri-book-mark-line text-primary ml-2"></i>
                                        <h4 class="font-medium">الأجزاء المحفوظة</h4>
                                    </div>
                                    <span class="text-3xl font-bold text-primary">
                                        {{ student_data.current_juz|default:0 }}
                                        <span class="text-sm text-gray-600 font-normal">من 30 جزء</span>
                                    </span>
                                </div>

                                <!-- Reviews -->
                                <div class="bg-blue-50 rounded-lg p-4 card-hover">
                                    <div class="flex items-center mb-2">
                                        <i class="ri-refresh-line text-blue-600 ml-2"></i>
                                        <h4 class="font-medium">المراجعات</h4>
                                    </div>
                                    <span class="text-3xl font-bold text-blue-600">
                                        {{ student_data.reviews|default:0 }}
                                        <span class="text-sm text-gray-600 font-normal">مراجعة ناجحة</span>
                                    </span>
                                </div>

                                <!-- Attendance -->
                                <div class="bg-yellow-50 rounded-lg p-4 card-hover">
                                    <div class="flex items-center mb-2">
                                        <i class="ri-time-line text-yellow-600 ml-2"></i>
                                        <h4 class="font-medium">الالتزام</h4>
                                    </div>
                                    <span class="text-3xl font-bold text-yellow-600">
                                        {{ student_data.commitment|default:0 }}%
                                        <span class="text-sm text-gray-600 font-normal">معدل الحضور</span>
                                    </span>
                                </div>

                                <!-- Evaluation -->
                                <div class="bg-purple-50 rounded-lg p-4 card-hover">
                                    <div class="flex items-center mb-2">
                                        <i class="ri-award-line text-purple-600 ml-2"></i>
                                        <h4 class="font-medium">التقييم</h4>
                                    </div>
                                    <span class="text-3xl font-bold text-purple-600">
                                        {{ student_data.rating|default:0 }}
                                        <span class="text-sm text-gray-600 font-normal">من 5</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-lg font-bold mb-4">تقدم الحفظ الأسبوعي</h3>
                        <div id="weeklyLineChart" style="width: 100%; height: 300px;"></div>
                    </div>
                </div>
                <script>
                    const yLabels = ['ضعيف', 'جيد', 'جيد جدًا', 'ممتاز', 'ممتاز جدًا'];

                    async function initWeeklyLineChart(studentId) {
                        let data;
                        try {
                            const response = await fetch(`/weekly-progress/${studentId}/`);
                            data = await response.json();
                        } catch (e) {
                            data = null;
                        }

                        let days = ["السبت", "الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];
                        let memorized = [];
                        let reviews = [];
                        if (
                            !data ||
                            !data.memorized ||
                            !data.reviews
                        ) {
                            memorized = Array(7).fill('ضعيف');
                            reviews = Array(7).fill('ضعيف');
                        } else {
                            days = data.days || days;
                            memorized = data.memorized;
                            reviews = data.reviews;
                        }

                        // حول القيم النصية إلى index لعرضها على yAxis من نوع category
                        const memorizedIdx = memorized.map(v => yLabels.indexOf(v));
                        const reviewsIdx = reviews.map(v => yLabels.indexOf(v));

                        const chartDom = document.getElementById('weeklyLineChart');
                        const chart = echarts.init(chartDom);

                        const option = {
                            tooltip: {
                                trigger: 'axis',
                                formatter: function (params) {
                                    let res = params[0].axisValue + '<br>';
                                    params.forEach(function (item) {
                                        let label = item.seriesName;
                                        let idx = item.value;
                                        let rating = yLabels[idx];
                                        res += label + ':<br><b>' + rating + '</b><br>';
                                    });
                                    return res;
                                }
                            },
                            legend: { data: ['الآيات المحفوظة', 'المراجعات'], right: 20 },
                            grid: { left: '5%', right: '5%', bottom: '5%', containLabel: true },
                            xAxis: { type: 'category', boundaryGap: false, data: days },
                            yAxis: {
                                type: 'category',
                                data: yLabels,
                                axisLabel: { formatter: value => value }
                            },
                            series: [
                                {
                                    name: 'الآيات المحفوظة',
                                    type: 'line',
                                    smooth: true,
                                    data: memorizedIdx,
                                    itemStyle: { color: '#2563eb' },
                                    areaStyle: {},
                                    label: {
                                        show: true,
                                        position: 'right',
                                        formatter: function (params) {
                                            return yLabels[params.value];
                                        }
                                    }
                                },
                                {
                                    name: 'المراجعات',
                                    type: 'line',
                                    smooth: true,
                                    data: reviewsIdx,
                                    itemStyle: { color: '#10b981' },
                                    areaStyle: {},
                                    label: {
                                        show: true,
                                        position: 'right',
                                        formatter: function (params) {
                                            return yLabels[params.value];
                                        }
                                    }
                                }
                            ]
                        };

                        chart.setOption(option);
                        window.addEventListener('resize', chart.resize);
                    }

                    const studentId = "{{ student.id }}";
                    initWeeklyLineChart(studentId);
                </script>






                <!-- Messages Section -->
                <div class="card card-hover">
                    <h2 class="text-xl font-bold mb-6">جدول الحصص والاجتماعات</h2>
                    <div class="flex gap-2 mb-4">
                        <button id="show-upcoming"
                            class="tab-button bg-primary text-white px-4 py-2 rounded-md">القادمة</button>
                        <button id="show-past"
                            class="tab-button bg-gray-100 text-gray-700 px-4 py-2 rounded-md">السابقة</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table w-full" id="schedule-table">
                            <thead>
                                <tr>
                                    <th>العنوان</th>
                                    <th>اليوم والتاريخ</th>
                                    <th>الوقت</th>
                                    <th>المعلم</th>
                                    <th>الانضمام</th>
                                </tr>
                            </thead>
                            <tbody>
                                {# القادمة #}
                                {% for item in lessons %}
                                {% if item.date >= today %}
                                <tr class="row-upcoming">
                                    <td>{{ item.title|default:item.content|default:'-' }}</td>
                                    <td>{{ item.date|default:'-' }}</td>
                                    <td>{{ item.time|default:'-' }}</td>
                                    <td>
                                        <div class="flex items-center">
                                            <img src="{{ item.teacher.image|default:'https://randomuser.me/api/portraits/men/1.jpg' }}"
                                                alt="صورة المعلم" class="w-8 h-8 rounded-full ml-2">
                                            <span>{{ item.teacher.name|default:'-' }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if item.meeting_link %}
                                        <a href="{{ item.meeting_link }}" target="_blank"
                                            class="btn btn-sm bg-blue-500 text-white rounded px-3 py-1">الانضمام</a>
                                        {% elif item.record_link %}
                                        <a href="{{ item.record_link }}" target="_blank"
                                            class="btn btn-sm bg-gray-500 text-white rounded px-3 py-1">مشاهدة
                                            التسجيل</a>
                                        {% else %}
                                        <span class="text-gray-400">لا يوجد رابط</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                                {% empty %}
                                <tr class="row-upcoming">
                                    <td colspan="5" class="text-center text-gray-400 py-4">لا يوجد حصص أو اجتماعات
                                        قادمة.</td>
                                </tr>
                                {% endfor %}

                                {# السابقة #}
                                {% for item in lessons %}
                                {% if item.date < today %} <tr class="row-past" style="display: none;">
                                    <td>{{ item.title|default:item.content|default:'-' }}</td>
                                    <td>{{ item.date|default:'-' }}</td>
                                    <td>{{ item.time|default:'-' }}</td>
                                    <td>
                                        <div class="flex items-center">
                                            <img src="{{ item.teacher.image|default:'https://randomuser.me/api/portraits/men/1.jpg' }}"
                                                alt="صورة المعلم" class="w-8 h-8 rounded-full ml-2">
                                            <span>{{ item.teacher.name|default:'-' }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if item.meeting_link %}
                                        <a href="{{ item.meeting_link }}" target="_blank"
                                            class="btn btn-sm bg-blue-500 text-white rounded px-3 py-1">الانضمام</a>
                                        {% elif item.record_link %}
                                        <a href="{{ item.record_link }}" target="_blank"
                                            class="btn btn-sm bg-gray-500 text-white rounded px-3 py-1">مشاهدة
                                            التسجيل</a>
                                        {% else %}
                                        <span class="text-gray-400">لا يوجد رابط</span>
                                        {% endif %}
                                    </td>
                                    </tr>
                                    {% endif %}
                                    {% empty %}
                                    <tr class="row-past" style="display: none;">
                                        <td colspan="5" class="text-center text-gray-400 py-4">لا يوجد حصص أو اجتماعات
                                            سابقة.</td>
                                    </tr>
                                    {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <script>
                    // تفعيل التبديل بين القادمة والسابقة
                    document.addEventListener('DOMContentLoaded', function () {
                        const btnUpcoming = document.getElementById('show-upcoming');
                        const btnPast = document.getElementById('show-past');
                        const rowsUpcoming = document.querySelectorAll('.row-upcoming');
                        const rowsPast = document.querySelectorAll('.row-past');

                        btnUpcoming.addEventListener('click', function () {
                            btnUpcoming.classList.add('bg-primary', 'text-white');
                            btnUpcoming.classList.remove('bg-gray-100', 'text-gray-700');
                            btnPast.classList.remove('bg-primary', 'text-white');
                            btnPast.classList.add('bg-gray-100', 'text-gray-700');
                            rowsUpcoming.forEach(row => row.style.display = '');
                            rowsPast.forEach(row => row.style.display = 'none');
                        });

                        btnPast.addEventListener('click', function () {
                            btnPast.classList.add('bg-primary', 'text-white');
                            btnPast.classList.remove('bg-gray-100', 'text-gray-700');
                            btnUpcoming.classList.remove('bg-primary', 'text-white');
                            btnUpcoming.classList.add('bg-gray-100', 'text-gray-700');
                            rowsUpcoming.forEach(row => row.style.display = 'none');
                            rowsPast.forEach(row => row.style.display = '');
                        });

                        // الوضع الافتراضي: عرض القادمة فقط
                        rowsUpcoming.forEach(row => row.style.display = '');
                        rowsPast.forEach(row => row.style.display = 'none');
                    });
                </script>
                <!-- Evaluation Section -->
                <div class="card card-hover">
                    <h2 class="text-xl font-bold mb-6">التقييم والمتابعة</h2>

                    {% if evaluations %}
                    {% with evaluation=evaluations.0 %}
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <img src="{{ evaluation.teacher_img|default:'https://randomuser.me/api/portraits/men/1.jpg' }}"
                                alt="صورة المعلم" class="w-12 h-12 rounded-full ml-4">
                            <div>
                                <div class="flex items-center mb-2">
                                    <h4 class="font-medium">{{ evaluation.teacher|default:'-' }}</h4>
                                    <span class="mx-2 text-gray-400">•</span>
                                    <span class="text-gray-600 text-sm">{{ evaluation.date|default:'-' }}</span>
                                </div>
                                <div class="flex mb-3">
                                    {% for i in "12345" %}
                                    <i
                                        class="ri-star-fill {% if forloop.counter <= evaluation.stars|default:0 %}text-yellow-500{% else %}text-gray-300{% endif %} ml-1"></i>
                                    {% endfor %}
                                </div>
                                <p class="text-gray-700">{{ evaluation.comment|default:'لا يوجد تعليق.' }}</p>
                            </div>
                        </div>

                        {% if evaluation.details %}
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h5 class="font-medium mb-4">تفاصيل التقييم:</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {% for section in evaluation.details %}
                                <div>
                                    {% for item in section %}
                                    <div class="flex justify-between items-center mb-3">
                                        <span class="text-gray-600">{{ item.label }}</span>
                                        <div class="flex">
                                            {% for j in "12345" %}
                                            <i
                                                class="ri-star-fill text-sm {% if forloop.counter <= item.stars %}text-yellow-500{% else %}text-gray-300{% endif %} ml-1"></i>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endwith %}
                    {% else %}
                    <div class="text-center text-gray-400 py-8">لا يوجد تقييم بعد.</div>
                    {% endif %}

                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-medium mb-4">خطة المراجعة اليومية</h3>




                        {% for plan in plans %}
                        <div class="plan-card"
                            style="text-align: right; margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 10px; background: #f9f9f9;">


                            <!-- الوصف -->
                            <p style="margin: 5px 0;">{{ plan.title }}</p>
                            <p style="margin: 5px 0;">{{ plan.description }}</p>

                            <!-- التاريخ -->
                            <p style="margin: 5px 0;">اليوم: {{ plan.day }}</p>
                            <p style="margin: 5px 0;">السورة: {{ plan.surah }}</p>
                            <p style="margin: 5px 0;">عدد الآيات: {{ plan.ayat_count }}</p>

                            <!-- زر التذكير -->
                            <div style="display: flex; align-items: center; margin-top: 10px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" class="reminder-toggle" data-id="{{ plan.id }}" {% if plan.reminder_enabled %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                                <span style="margin-right: 10px;">تفعيل التذكير اليومي</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-top: 10px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" class="completed-toggle" data-id="{{ plan.id }}" {% if plan.is_completed %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                                <span style="margin-right: 10px;">تحديد الخطة كمكتملة</span>
                            </div>
                        </div>
                        {% empty %}
                        <p>لا توجد خطط مراجعة مرتبطة بك حالياً.</p>
                        {% endfor %}

                    </div>
                </div>
          
        
        <script>
            function showNotification(title, message) {
                // نعمل عنصر popup
                let notif = document.createElement("div");
                notif.className = "popup-notif";
                notif.innerHTML = `<strong>${title}</strong><br>${message}`;

                // نضيفه في الصفحة
                document.body.appendChild(notif);

                // يختفي بعد 5 ثواني
                setTimeout(() => {
                    notif.remove();
                }, 5000);
            }
            function showNotification(title, message) {
                Swal.fire({
                    title: title,
                    text: message,
                    icon: 'info',
                    allowOutsideClick: false,  // ما يتقفلش لو ضغط برا
                    showConfirmButton: true,   // زرار موافق
                    confirmButtonText: "إغلاق"
                });
            }

            // كل دقيقة نجيب آخر إشعار
            setInterval(() => {
                fetch("/notifications/latest/")
                    .then(response => response.json())
                    .then(data => {
                        if (data.title) {
                            showNotification(data.title, data.message);
                        }
                    });
            }, 60000); // 60000ms = دقيقة

            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".reminder-toggle").forEach(function (toggle) {
                    toggle.addEventListener("change", function () {
                        let planId = this.getAttribute("data-id");
                        let isChecked = this.checked;  // ✅ القيمة الجديدة

                        fetch(`/toggle-reminder/${planId}/`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": "{{ csrf_token }}",
                            },
                            body: JSON.stringify({ reminder_enabled: isChecked })  // نبعت القيمة
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    console.log("تم تحديث التذكير:", data.reminder_enabled);
                                } else {
                                    alert("خطأ: " + data.error);
                                }
                            });
                    });
                });
            });

            document.addEventListener("DOMContentLoaded", function () {
                // تفعيل / تعطيل التذكير
                document.querySelectorAll(".reminder-toggle").forEach(function (toggle) {
                    toggle.addEventListener("change", function () {
                        let planId = this.getAttribute("data-id");
                        let isChecked = this.checked;

                        fetch(`/toggle-reminder/${planId}/`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": "{{ csrf_token }}",
                            },
                            body: JSON.stringify({ reminder_enabled: isChecked })
                        });
                    });
                });

                // ✅ تفعيل / تعطيل الاكتمال
                document.querySelectorAll(".completed-toggle").forEach(function (toggle) {
                    toggle.addEventListener("change", function () {
                        let planId = this.getAttribute("data-id");
                        let isChecked = this.checked;

                        fetch(`/toggle-completed/${planId}/`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": "{{ csrf_token }}",
                            },
                            body: JSON.stringify({ is_completed: isChecked })
                        });
                    });
                });
            });
        </script>
        <!-- Subscription Status -->
        <div class="card card-hover">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6">
                <h2 class="text-xl font-bold">حالة الاشتراك</h2>
                <div class="flex items-center mt-2 md:mt-0">
                    <span class="text-gray-600 ml-2">الحالة:</span>
                    <span class="status-badge status-active">نشط</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Subscription Details -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4">تفاصيل الاشتراك</h3>
                    {% if subscription %}
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">نوع الاشتراك:</span>
                            <span class="font-medium text-primary">{{ subscription.type|default:'اشتراك شهري' }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">بداية الاشتراك:</span>
                            <span>{{ subscription.start_date|default:'01/01/2024' }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">تاريخ الانتهاء:</span>
                            <span>{{ subscription.end_date|default:'31/12/2024' }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">الحالة:</span>
                            <span
                                class="{% if subscription.is_active %}text-green-600{% else %}text-gray-600{% endif %}">
                                {{ subscription.display_status }}
                            </span>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-gray-400 mb-2">لا يوجد اشتراك.</p>
                        <a href="{% url 'inbox' %}"
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                            الاشتراك الآن
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- Subscription Features -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4">مميزات الباقة الحالية</h3>
                    <ul class="space-y-3">
                        <li class="flex items-center">
                            <i class="ri-checkbox-circle-fill text-primary ml-2"></i>
                            <span>حصص مباشرة أسبوعية</span>
                        </li>
                        
                        <li class="flex items-center">
                            <i class="ri-checkbox-circle-fill text-primary ml-2"></i>
                            <span>متابعة أسبوعية مع المعلم</span>
                        </li>
                        <li class="flex items-center">
                            <i class="ri-checkbox-circle-fill text-primary ml-2"></i>
                            <span>تصحيح التلاوة</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="bg-gray-50 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">سجل المدفوعات</h3>
                    <button class="text-primary hover:underline text-sm">تصدير السجل</button>
                </div>


                <!-- آخر اشتراك -->
                <div class="bg-gray-50 rounded-lg p-6 mt-6">
                    <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('all-subscriptions').classList.toggle('hidden'); 
                      this.querySelector('svg').classList.toggle('rotate-180');">
                        <h3 class="text-lg font-bold">📌 آخر اشتراك</h3>
                        <!-- السهم -->
                        <svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>

                    {% if latest_subscription %}
                    <div class="p-4 border rounded-lg bg-white shadow flex flex-wrap gap-6 mt-4">
                        <p><strong>الخطة:</strong> {{ latest_subscription.plan.name }}</p>
                        <p><strong>المبلغ:</strong> {{ latest_subscription.price }} جنيه</p>
                        <p><strong>الحالة:</strong> {{ latest_subscription.display_status }}</p>
                        <p><strong>تاريخ البداية:</strong> {{ latest_subscription.start_date|date:"Y-m-d" }}</p>
                        <p><strong>تاريخ الانتهاء:</strong> {{ latest_subscription.end_date|date:"Y-m-d" }}</p>
                        <p><strong>الإيصال:</strong>
                            {% if latest_subscription.payment_image %}
                            <a href="{{ latest_subscription.payment_image.url }}" target="_blank"
                                class="text-primary hover:underline">
                                عرض الإيصال
                            </a>
                            <!-- صورة مصغرة -->
                            <img src="{{ latest_subscription.payment_image.url }}" alt="إيصال الدفع"
                                class="w-20 h-20 object-cover rounded border mt-2">
                            {% else %}
                            لا يوجد
                            {% endif %}
                        </p>
                    </div>
                    {% else %}
                    <p class="text-gray-500">لا يوجد اشتراكات بعد.</p>
                    {% endif %}

                    <!-- باقي الاشتراكات -->
                    <div id="all-subscriptions" class="hidden mt-6 space-y-4">
                        {% for sub in subscriptions %}
                        {% if sub.id != latest_subscription.id %}
                        <div class="p-4 border rounded-lg bg-white shadow flex flex-wrap gap-6">
                            <p><strong>الخطة:</strong> {{ sub.plan.name }}</p>
                            <p><strong>المبلغ:</strong> {{ sub.price }} جنيه</p>
                            <p><strong>الحالة:</strong> {{ sub.display_status }}</p>
                            <p><strong>تاريخ البداية:</strong> {{ sub.start_date|date:"Y-m-d" }}</p>
                            <p><strong>تاريخ الانتهاء:</strong> {{ sub.end_date|date:"Y-m-d" }}</p>
                            <p><strong>الإيصال:</strong>
                                {% if sub.payment_image %}
                                <a href="{{ sub.payment_image.url }}" target="_blank"
                                    class="text-primary hover:underline">عرض الإيصال</a>
                                {% else %}
                                لا يوجد
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}
                        {% empty %}
                        <p class="text-gray-500">لا يوجد اشتراكات سابقة.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        <!-- Footer -->
        <footer class="bg-white border-t py-4 text-center text-gray-500 text-sm">
            جميع الحقوق محفوظة &copy; منصة القرآن الكريم {{ year|default:'2025' }}
        </footer>

        <!-- JavaScript -->
        <script src="{% static 'js/student_dashboard.js' %}"></script>
        <!-- Modal --><!-- SweetAlert2 -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        {% if not is_complete %}
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                Swal.fire({
                    title: "أكمل بياناتك",
                    html: `
            <form id="profileForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <label style="display:block; margin-top:10px; font-weight:bold;">إدخال صورة لك:</label>
                <input type="file" name="image" class="swal2-file">
                <label style="display:block; margin-top:10px; font-weight:bold;">الاسم:</label>
                <input type="text" name="name" class="swal2-input" value="{{ request.user.name }}">

                <label style="display:block; margin-top:10px; font-weight:bold;">العمر:</label>
                <input type="number" name="age" class="swal2-input" value="{{ student_data.age }}">

                <label style="display:block; margin-top:10px; font-weight:bold;">المدينة:</label>
                <input type="text" name="city" class="swal2-input" value="{{ student_data.city }}">

                <label style="display:block; margin-top:10px; font-weight:bold;">المستوى:</label>
                <input type="text" name="level" class="swal2-input" value="{{ student_data.level }}">
                <label style="display:block; margin-top:10px; font-weight:bold;">السورة الحالية:</label>
                <input type="text" name="current_surah" class="swal2-input" value="{{ student_data.current_surah }}">

                <label style="display:block; margin-top:10px; font-weight:bold;">الجزء الحالي:</label>
                <input type="text" name="current_juz" class="swal2-input" value="{{ student_data.current_juz }}">
               
            </form>
        `,
                    confirmButtonText: "حفظ",
                    allowOutsideClick: false,
                    preConfirm: () => {
                        let form = document.getElementById("profileForm");
                        let formData = new FormData(form);

                        return fetch("{% url 'update_profile' %}", {
                            method: "POST",
                            body: formData,
                            headers: {
                                "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value
                            }
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error("حدث خطأ أثناء الحفظ");
                                }
                                return response.text();
                            })
                            .then(() => {
                                Swal.fire({
                                    icon: "success",
                                    title: "تم الحفظ",
                                    text: "✅ تم تحديث بياناتك بنجاح",
                                }).then(() => {
                                    location.reload();
                                });
                            })
                            .catch(error => {
                                Swal.showValidationMessage(error);
                            });
                    }
                });
            });
        </script>
        {% endif %}


</body>

</html>