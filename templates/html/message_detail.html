<!DOCTYPE html>
{% load static %}
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل الرسالة - بالقرآن نحيا</title>
    <!-- Bootstrap RTL CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tajawal Font -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a3a30;
            --secondary: #c9b67a;
            --light: #f8f9fa;
            --dark: #343a40;
            --light-gray: #e9ecef;
            --success: #198754;
            --info: #0dcaf0;
            --warning: #ffc107;
            --danger: #dc3545;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            padding-top: 70px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navbar Styles */
        .navbar {
            background-color: var(--primary) !important;
            border-bottom: 2px solid var(--secondary);
            padding: 0.5rem 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: white !important;
            display: flex;
            align-items: center;
        }

        .navbar-brand img {
            height: 40px;
            margin-left: 10px;
        }

        .nav-link {
            color: white !important;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            color: var(--secondary) !important;
        }

        .btn-outline-light {
            border-color: var(--secondary);
            color: white;
            margin-right: 5px;
        }

        .btn-outline-light:hover {
            background-color: var(--secondary);
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px 0;
        }

        /* Message Detail Styles */
        .message-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .message-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-header h1 {
            font-size: 1.5rem;
            margin: 0;
            font-weight: 600;
        }

        .message-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
        }

        .message-meta-item {
            display: flex;
            align-items: center;
        }

        .message-meta-item i {
            margin-left: 5px;
        }

        .message-body {
            padding: 25px;
            line-height: 1.8;
            border-bottom: 1px solid #eee;
        }

        .message-content {
            white-space: pre-line;
            margin-bottom: 20px;
        }

        .message-attachments {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #eee;
        }

        .attachment {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f9f9f9;
            border-radius: 5px;
            margin-bottom: 8px;
            border: 1px solid #eee;
        }

        .attachment i {
            margin-left: 10px;
            color: var(--primary);
            font-size: 1.2em;
        }

        .attachment-info {
            flex-grow: 1;
        }

        .attachment-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .attachment-size {
            font-size: 0.8em;
            color: #6c757d;
        }

        /* Reply Section */
        .reply-section {
            padding: 20px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
        }

        .reply-form {
            margin-top: 20px;
        }

        .form-control {
            border-radius: 8px;
            padding: 12px 15px;
            border: 1px solid #ddd;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 0.25rem rgba(201, 182, 122, 0.25);
        }

        textarea.form-control {
            min-height: 150px;
            resize: vertical;
        }

        .btn-primary {
            background-color: var(--secondary);
            border-color: var(--secondary);
            padding: 10px 25px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background-color: #b89a4c;
            border-color: #b89a4c;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-outline-secondary {
            border-color: #6c757d;
            color: #6c757d;
        }

        .btn-outline-secondary:hover {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        /* Thread Styles */
        .message-thread {
            margin-top: 30px;
        }

        .thread-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
            border-right: 3px solid var(--secondary);
        }

        .thread-header {
            background: #f8f9fa;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .thread-sender {
            font-weight: 600;
            color: var(--primary);
        }

        .thread-date {
            font-size: 0.85em;
            color: #6c757d;
        }

        .thread-body {
            padding: 20px;
            line-height: 1.7;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        /* Status Badges */
        .badge {
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 5px;
        }

        .badge-status-new {
            background-color: var(--info);
        }

        .badge-status-read {
            background-color: var(--success);
        }

        .badge-status-replied {
            background-color: var(--primary);
        }

        .badge-type-notification {
            background-color: var(--warning);
            color: #000;
        }

        .badge-type-message {
            background-color: var(--info);
        }

        .badge-type-support {
            background-color: var(--danger);
        }

        /* Footer Styles */
        .site-footer {
            background: var(--primary);
            color: white;
            padding: 20px 0;
            margin-top: 40px;
            position: relative;
        }

        .site-footer:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--secondary);
        }

        .footer-bottom {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 15px;
        }

        .footer-bottom p {
            margin: 0;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .message-header h1 {
                font-size: 1.3rem;
            }

            .message-meta {
                flex-direction: column;
                gap: 8px;
            }

            .message-body,
            .reply-section {
                padding: 15px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #b89a4c;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}">
                <img src="{% static 'images/logo.png' %}" alt="شعار المنصة">
                بالقرآن نحيا
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="تبديل التنقل">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'home' %}">الرئيسية</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'courses' %}">الدورات</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'teachers' %}">المعلمون</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'contact' %}">تواصل معنا</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'message_list' %}">
                            الرسائل
                            {% if unread_count > 0 %}
                            <span class="position-relative">
                                <span
                                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                    style="font-size: 0.6em; padding: 3px 6px;">
                                    {{ unread_count }}
                                    <span class="visually-hidden">رسائل غير مقروءة</span>
                                </span>
                            </span>
                            {% endif %}
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    {% if user.is_authenticated %}
                    {% if user.is_staff %}
                    <a href="/admin/" class="btn btn-outline-light me-2">
                        <i class="fas fa-tachometer-alt"></i> لوحة التحكم
                    </a>
                    {% endif %}
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i> {{ user.get_full_name|default:user.username }}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="{% url 'profile' %}"><i
                                        class="fas fa-user me-2"></i>الملف الشخصي</a></li>
                            <li><a class="dropdown-item" href="{% url 'message_list' %}">
                                    <i class="fas fa-envelope me-2"></i>الرسائل
                                    {% if unread_count > 0 %}
                                    <span class="badge bg-danger rounded-pill ms-2">{{ unread_count }}</span>
                                    {% endif %}
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="{% url 'logout' %}"><i
                                        class="fas fa-sign-out-alt me-2"></i>تسجيل خروج</a></li>
                        </ul>
                    </div>
                    {% else %}
                    <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-light me-2">
                        <i class="fas fa-sign-in-alt"></i> تسجيل دخول
                    </a>
                    <a href="{% url 'signup' %}" class="btn btn-light"
                        style="background-color: var(--secondary); border-color: var(--secondary);">
                        <i class="fas fa-user-plus"></i> إنشاء حساب
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <!-- Sidebar Navigation -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-inbox me-2"></i>الرسائل</h5>
                        </div>
                        <div class="list-group list-group-flush">
                            <a href="{% url 'message_list' %}" class="list-group-item list-group-item-action">
                                <i class="fas fa-arrow-right me-2"></i> العودة للرسائل
                            </a>
                            <a href="{% url 'contact' %}" class="list-group-item list-group-item-action text-success">
                                <i class="fas fa-paper-plane me-2"></i> إرسال رسالة جديدة
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9">
                    <!-- Message Header -->
                    <div class="message-container fade-in">
                        <div class="message-header">
                            <h1>{{ message.subject }}</h1>
                            <div class="message-meta">
                                <div class="message-meta-item">
                                    <i class="far fa-user"></i>
                                    <span>المرسل: {{ message.sender.get_full_name|default:message.sender.username
                                        }}</span>
                                </div>
                                <div class="message-meta-item">
                                    <i class="far fa-calendar-alt"></i>
                                    <span>التاريخ: {{ message.created_at|date:"Y/m/d h:i A" }}</span>
                                </div>
                                <div class="message-meta-item">
                                    <i class="fas fa-tag"></i>
                                    <span>النوع:
                                        <span class="badge badge-type-{{ message.get_message_type_display|lower }}">
                                            {{ message.get_message_type_display }}
                                        </span>
                                    </span>
                                </div>
                                <div class="message-meta-item">
                                    <i class="fas fa-info-circle"></i>
                                    <span>الحالة:
                                        <span class="badge badge-status-{{ message.get_status_display|lower }}">
                                            {{ message.get_status_display }}
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Message Body -->
                        <div class="message-body">
                            <div class="message-content">
                                {{ message.content|linebreaks }}
                            </div>

                            {% if message.attachments.exists %}
                            <div class="message-attachments">
                                <h6><i class="fas fa-paperclip me-2"></i>المرفقات:</h6>
                                {% for attachment in message.attachments.all %}
                                <div class="attachment">
                                    <i class="fas fa-file-{{ attachment.get_file_type_icon }}"></i>
                                    <div class="attachment-info">
                                        <div class="attachment-name">{{ attachment.get_filename }}</div>
                                        <div class="attachment-size">{{ attachment.get_file_size }}</div>
                                    </div>
                                    <a href="{{ attachment.file.url }}" class="btn btn-sm btn-outline-primary" download>
                                        <i class="fas fa-download"></i> تحميل
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons px-4 pb-4">
                            <a href="{% url 'message_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-right me-1"></i> العودة للقائمة
                            </a>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#replyModal">
                                <i class="fas fa-reply me-1"></i> الرد على الرسالة
                            </button>
                            {% if not message.is_from_admin or user.is_staff %}
                            <a href="{% url 'delete_message' message.id %}" class="btn btn-outline-danger"
                                onclick="return confirm('هل أنت متأكد من حذف هذه الرسالة؟');">
                                <i class="fas fa-trash me-1"></i> حذف
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Thread History -->
                    {% if message.replies.exists %}
                    <div class="message-thread">
                        <h5 class="mb-4"><i class="fas fa-history me-2"></i>سجل المحادثة</h5>

                        {% for reply in message.replies.all %}
                        <div class="thread-item fade-in"
                            style="animation-delay: {{ forloop.counter|floatformat:1 }}0.1s;">
                            <div class="thread-header">
                                <div class="thread-sender">
                                    {% if reply.sender == request.user %}
                                    أنت
                                    {% else %}
                                    {{ reply.sender.get_full_name|default:reply.sender.username }}
                                    {% endif %}
                                </div>
                                <div class="thread-date">
                                    <i class="far fa-clock me-1"></i> {{ reply.created_at|timesince }} مضت
                                </div>
                            </div>
                            <div class="thread-body">
                                {{ reply.content|linebreaks }}

                                {% if reply.attachments.exists %}
                                <div class="mt-3">
                                    <h6><i class="fas fa-paperclip me-2"></i>المرفقات:</h6>
                                    {% for attachment in reply.attachments.all %}
                                    <div class="attachment mt-2">
                                        <i class="fas fa-file-{{ attachment.get_file_type_icon }}"></i>
                                        <div class="attachment-info">
                                            <div class="attachment-name">{{ attachment.get_filename }}</div>
                                            <div class="attachment-size">{{ attachment.get_file_size }}</div>
                                        </div>
                                        <a href="{{ attachment.file.url }}" class="btn btn-sm btn-outline-primary"
                                            download>
                                            <i class="fas fa-download"></i> تحميل
                                        </a>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </main>

    <!-- Reply Modal -->
    <div class="modal fade" id="replyModal" tabindex="-1" aria-labelledby="replyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="replyModalLabel">الرد على الرسالة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="replyContent" class="form-label">الرد</label>
                            <textarea class="form-control" id="replyContent" name="content" rows="8"
                                required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="attachments" class="form-label">المرفقات (اختياري)</label>
                            <input class="form-control" type="file" id="attachments" name="attachments" multiple>
                            <div class="form-text">يمكنك رفع أكثر من ملف في نفس الوقت</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-1"></i> إرسال الرد
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 جميع الحقوق محفوظة لموقع بالقرآن نحيا</p>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="container">
                    <div class="row">
                        <div class="col-12 text-center">
                            <a href="{% url 'privacy' %}" class="text-white-50 me-3">سياسة الخصوصية</a>
                            <a href="{% url 'terms' %}" class="text-white-50">الشروط والأحكام</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

    <script>
        // Mark message as read when page loads
        document.addEventListener('DOMContentLoaded', function () {
            // Update unread count in navbar
            function updateUnreadCount() {
                fetch('{% url "get_unread_count" %}')
                    .then(response => response.json())
                    .then(data => {
                        const unreadBadge = document.querySelector('.navbar .badge');
                        if (unreadBadge) {
                            unreadBadge.textContent = data.unread_count;
                            if (data.unread_count > 0) {
                                unreadBadge.classList.remove('d-none');
                            } else {
                                unreadBadge.classList.add('d-none');
                            }
                        }
                    });
            }

            // Mark message as read
            fetch('{% url "mark_message_read" message.id %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateUnreadCount();
                    }
                });

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Handle file input change
            const fileInput = document.getElementById('attachments');
            if (fileInput) {
                fileInput.addEventListener('change', function () {
                    const files = this.files;
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    let totalSize = 0;
                    let hasError = false;

                    // Check each file size and total size
                    for (let i = 0; i < files.length; i++) {
                        totalSize += files[i].size;
                        if (files[i].size > 5 * 1024 * 1024) { // 5MB per file
                            alert('حجم الملف ' + files[i].name + ' يتجاوز الحد المسموح به (5 ميجابايت)');
                            hasError = true;
                            break;
                        }
                    }

                    if (totalSize > maxSize) {
                        alert('إجمالي حجم المرفقات يتجاوز الحد المسموح به (10 ميجابايت)');
                        this.value = '';
                        hasError = true;
                    }

                    if (hasError) {
                        this.value = '';
                    }
                });
            }

            // Auto-resize textarea
            const textarea = document.getElementById('replyContent');
            if (textarea) {
                textarea.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
        });
    </script>
</body>

</html>